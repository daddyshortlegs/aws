- name: Setup nodes
  hosts: workers
  become: yes
  tasks:
   - name: Create aws directory
     ansible.builtin.file:
       path: "{{ item }}"
       state: directory
       mode: '0755'
     with_items:
       - /home/andy/aws/backend
       - /home/andy/aws/vm-data

   - name: Copy server
     ansible.builtin.copy:
       src: "{{ item }}"
       dest: /home/andy/aws/backend/
       mode: '0755'
     with_items:
       - target/release/vm-launcher
       - alpine.qcow2

   - name: Copy config file
     ansible.builtin.copy:
       src: config.ci.toml
       dest: /home/andy/aws/backend/config.toml

   - name: Create systemd service file
     ansible.builtin.copy:
       content: |
         [Unit]
         Description=Backend Rust Server
         After=network.target

         [Service]
         Type=simple
         User=andy
         WorkingDirectory=/home/andy/aws/backend
         ExecStart=/home/andy/aws/backend/vm-launcher
         Restart=always
         RestartSec=10
         Environment="RUST_LOG=info"

         [Install]
         WantedBy=multi-user.target
       dest: /etc/systemd/system/vm-launcher.service
       mode: '0644'

   - name: Reload systemd daemon
     ansible.builtin.systemd:
       daemon_reload: yes

   - name: Enable and start Rust backend service
     ansible.builtin.systemd:
       name: vm-launcher
       enabled: yes
       state: restarted
